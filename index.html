<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle de Antenas NASA</title>
    <link rel="stylesheet" href="style.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;
        let userId = 'anonymous'; // Default userId

        // Initialize Firebase and authenticate
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = `ID do Usuário: ${userId}`;
                    console.log("Firebase Authenticated. User ID:", userId);
                    // Start listening to global alarm state after authentication
                    setupGlobalAlarmListener();
                } else {
                    // Try to sign in anonymously if no user is logged in
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        // Fallback to anonymous if custom token fails
                        userId = crypto.randomUUID(); // Generate a random ID for unauthenticated users
                        document.getElementById('userIdDisplay').textContent = `ID do Usuário (offline): ${userId}`;
                        console.log("Using generated anonymous ID:", userId);
                    }
                }
            });
        } else {
            console.warn("Firebase config not found. Running in offline mode.");
            userId = crypto.randomUUID(); // Generate a random ID for offline mode
            document.getElementById('userIdDisplay').textContent = `ID do Usuário (offline): ${userId}`;
        }

        // Expose Firebase instances to the global scope for other scripts to use
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firestoreDb = db;
        window.currentUserId = userId; // Make userId globally accessible

        // Function to set up the real-time listener for the global alarm state
        function setupGlobalAlarmListener() {
            if (!db) {
                console.error("Firestore not initialized. Cannot set up alarm listener.");
                return;
            }

            const alarmDocRef = doc(db, `artifacts/${appId}/public/data/alarm_status/global_alarm`);

            onSnapshot(alarmDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && typeof data.isActive === 'boolean') {
                        if (data.isActive && !window.isAlarmActive) {
                            window.startAlarmSound();
                        } else if (!data.isActive && window.isAlarmActive) {
                            window.stopAlarmSound();
                        }
                    }
                } else {
                    // Document doesn't exist, create it with default state if needed
                    setDoc(alarmDocRef, { isActive: false, triggeredBy: null, timestamp: new Date() });
                }
            }, (error) => {
                console.error("Error listening to global alarm:", error);
            });
        }

        // Function to update the global alarm state in Firestore
        window.updateGlobalAlarmState = async (isActive, triggeredByAntennaId = null) => {
            if (!db) {
                console.error("Firestore not initialized. Cannot update alarm state.");
                return;
            }
            const alarmDocRef = doc(db, `artifacts/${appId}/public/data/alarm_status/global_alarm`);
            try {
                await setDoc(alarmDocRef, {
                    isActive: isActive,
                    triggeredBy: isActive ? triggeredByAntennaId : null,
                    timestamp: new Date(),
                    userId: window.currentUserId
                });
                console.log(`Global alarm state updated to: ${isActive}`);
            } catch (error) {
                console.error("Failed to update global alarm state:", error);
            }
        };
    </script>
</head>
<body>
    <div class="main-container">
        <h1>Painel de Controle de Antenas Gigantes da NASA</h1>
        <p id="userIdDisplay" class="user-id-display">ID do Usuário: Carregando...</p>

        <div class="content-wrapper">
            <div class="canvas-container">
                <canvas id="antennaCanvas"></canvas>
            </div>

            <div class="controls-info-container">
                <div class="section-card">
                    <h2 class="section-title">Controle de Antenas</h2>
                    <div id="antennaControls" class="antenna-controls-grid">
                        <div class="antenna-card" id="antenna1-card">
                            <h3 class="antenna-name">Antena 1 (Califórnia)</h3>
                            <p class="antenna-location">Localização: 34.20° N, 116.89° O</p>
                            <div class="control-group">
                                <label class="control-label" for="azimuth1">Azimute (°):</label>
                                <input type="range" id="azimuth1" min="0" max="359" value="0" class="range-input" disabled>
                                <span id="azimuthValue1" class="value-display">0°</span>

                                <label class="control-label" for="elevation1">Elevação (°):</label>
                                <input type="range" id="elevation1" min="0" max="90" value="45" class="range-input" disabled>
                                <span id="elevationValue1" class="value-display">45°</span>
                            </div>
                            <div class="button-group">
                                <button id="toggle1" class="control-button off">Ligar</button>
                                <button id="auto1" class="control-button auto-mode-off" disabled>Automático</button>
                            </div>
                            <button id="trackSatBtn1" class="control-button track-satellite mt-2" disabled>Rastrear Satélite</button>
                            <button id="commBtn1" class="control-button comm-button mt-2" disabled>Comunicação</button>
                            <button id="alarmBtn1" class="control-button alarm-button mt-2" disabled>Ativar Alarme</button>
                        </div>

                        <div class="antenna-card" id="antenna2-card">
                            <h3 class="antenna-name">Antena 2 (Espanha)</h3>
                            <p class="antenna-location">Localização: 40.43° N, 4.25° O</p>
                            <div class="control-group">
                                <label class="control-label" for="azimuth2">Azimute (°):</label>
                                <input type="range" id="azimuth2" min="0" max="359" value="120" class="range-input" disabled>
                                <span id="azimuthValue2" class="value-display">120°</span>

                                <label class="control-label" for="elevation2">Elevação (°):</label>
                                <input type="range" id="elevation2" min="0" max="90" value="60" class="range-input" disabled>
                                <span id="elevationValue2" class="value-display">60°</span>
                            </div>
                            <div class="button-group">
                                <button id="toggle2" class="control-button off">Ligar</button>
                                <button id="auto2" class="control-button auto-mode-off" disabled>Automático</button>
                            </div>
                            <button id="trackSatBtn2" class="control-button track-satellite mt-2" disabled>Rastrear Satélite</button>
                            <button id="commBtn2" class="control-button comm-button mt-2" disabled>Comunicação</button>
                            <button id="alarmBtn2" class="control-button alarm-button mt-2" disabled>Ativar Alarme</button>
                        </div>

                        <div class="antenna-card" id="antenna3-card">
                            <h3 class="antenna-name">Antena 3 (Austrália)</h3>
                            <p class="antenna-location">Localização: 35.40° S, 148.98° L</p>
                            <div class="control-group">
                                <label class="control-label" for="azimuth3">Azimute (°):</label>
                                <input type="range" id="azimuth3" min="0" max="359" value="240" class="range-input" disabled>
                                <span id="azimuthValue3" class="value-display">240°</span>

                                <label class="control-label" for="elevation3">Elevação (°):</label>
                                <input type="range" id="elevation3" min="0" max="90" value="30" class="range-input" disabled>
                                <span id="elevationValue3" class="value-display">30°</span>
                            </div>
                            <div class="button-group">
                                <button id="toggle3" class="control-button off">Ligar</button>
                                <button id="auto3" class="control-button auto-mode-off" disabled>Automático</button>
                            </div>
                            <button id="trackSatBtn3" class="control-button track-satellite mt-2" disabled>Rastrear Satélite</button>
                            <button id="commBtn3" class="control-button comm-button mt-2" disabled>Comunicação</button>
                            <button id="alarmBtn3" class="control-button alarm-button mt-2" disabled>Ativar Alarme</button>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Satélites Rastreados</h2>
                    <div id="trackedSatellites" class="satellite-list-container">
                        </div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Sinal dos Satélites</h2>
                    <div id="satelliteSignalDisplays" class="signal-display-container">
                        <p class="text-slate-400">Nenhum satélite sendo rastreado para exibir sinal.</p>
                    </div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Dados de Telemetria</h2>
                    <div id="telemetryDisplay" class="telemetry-display">
                        <p class="text-slate-400">Nenhum satélite sendo rastreado para exibir telemetria.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="satelliteSelectModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Selecione um Satélite para Rastrear</h3>
            <ul id="satelliteListForSelection">
                </ul>
            <button id="closeModalBtn">Cancelar</button>
        </div>
    </div>

    <script type="module" src="script.js"></script>
</body>
</html>

    
